{% comment %}
  Renders a megamenu for the header. Usage: {% render
  'header-mega-menu' %}
{% endcomment %}

<nav class="header__inline-menu nav-{{ section.settings.nav_position }}">
  <ul class="list-menu list-menu--inline" role="list">
    {%- for link in section.settings.menu.links -%}
      <li>
        {%- if link.links != blank -%}
          <header-menu>
            <details id="Details-HeaderMenu-{{ forloop.index }}" class="mega-menu">
              <summary
                id="HeaderMenu-{{ link.handle }}"
                class="header__menu-item list-menu__item link focus-inset"
              >
                <span
                  {%- if link.child_active %}
                    class="header__active-menu-item"
                  {% endif %}
                >
                  {{- link.title | escape -}}
                </span>
                {% render 'icon-caret' %}
              </summary>
              <div
                id="MegaMenu-Content-{{ forloop.index }}"
                class="mega-menu__content color-{{ section.settings.menu_color_scheme }} gradient motion-reduce global-settings-popup"
                tabindex="-1"
              >
                {% if section.settings.show_image_in_mega_menu == true %}
                  <div class="page-width">
                    <div class="custom_mega-menu">
                      <div class="mega_menu-wrap">
                        <div class="custom_mega-wrap">
                          <div class="mega_menu-container">
                            {% for block in section.blocks %}
                              {% case block.type %}
                                {% when 'mega_menu_item' %}
                                  <div class="mega_menu-info">
                                    {% if block.settings.text != blank %}
                                      <h2 class="mega_menu-tite">
                                        {{ block.settings.text }}
                                      </h2>
                                    {% endif %}
                                    <div class="store_service-wrap">
                                      {% if block.settings.text1 != blank %}
                                        <div class="menu_icons-wrap">
                                          <div class="menu_img">
                                            {% render 'icon-accordion', icon: block.settings.icon1 %}
                                          </div>
                                          <div class="menu_text-item">
                                            {{ block.settings.text1 }}
                                          </div>
                                        </div>
                                      {% endif %}
                                      {% if block.settings.text2 != blank %}
                                        <div class="menu_icons-wrap">
                                          <div class="menu_img">
                                            {% render 'icon-accordion', icon: block.settings.icon2 %}
                                          </div>
                                          <div class="menu_text-item">
                                            {{ block.settings.text2 }}
                                          </div>
                                        </div>
                                      {% endif %}
                                      {% if block.settings.text3 != blank %}
                                        <div class="menu_icons-wrap">
                                          <div class="menu_img">
                                            {% render 'icon-accordion', icon: block.settings.icon3 %}
                                          </div>
                                          <div class="menu_text-item">
                                            {{ block.settings.text3 }}
                                          </div>
                                        </div>
                                      {% endif %}
                                    </div>
                                  </div>
                              {% endcase %}
                            {% endfor %}
                          </div>
                          <ul
                            class="mega-menu__list page-width{% if link.levels == 1 %} mega-menu__list--condensed{% endif %}"
                            role="list"
                          >
                            {%- for childlink in link.links -%}
                              <li>
                                <a
                                  id="HeaderMenu-{{ link.handle }}-{{ childlink.handle }}"
                                  href="{{ childlink.url }}"
                                  class="button button--primary mega-menu__link mega-menu__link--level-2 link{% if childlink.current %} mega-menu__link--active{% endif %}"
                                  {% if childlink.current %}
                                    aria-current="page"
                                  {% endif %}
                                >
                                  {{ childlink.title | escape }}
                                </a>
                                {%- if childlink.links != blank -%}
                                  <ul class="list-unstyled" role="list">
                                    {%- for grandchildlink in childlink.links -%}
                                      <li>
                                        <a
                                          id="HeaderMenu-{{ link.handle }}-{{ childlink.handle }}-{{ grandchildlink.handle }}"
                                          href="{{ grandchildlink.url }}"
                                          class="mega-menu__link link{% if grandchildlink.current %} mega-menu__link--active{% endif %}"
                                          {% if grandchildlink.current %}
                                            aria-current="page"
                                          {% endif %}
                                        >
                                          {{ grandchildlink.title | escape }}
                                        </a>
                                      </li>
                                    {%- endfor -%}
                                  </ul>
                                {%- endif -%}
                              </li>
                            {%- endfor -%}
                          </ul>
                        </div>
                        {% if section.settings.collection_list != blank %}
                          <div class="mega_menu-collection">
                            <div class="menu_collection-wrapper">
                              {% for collection in section.settings.collection_list %}
                                <div class="collection__items">
                                  <a href="{{ collection.url }}">
                                    <div class="custom_menu_wrap">
                                      {% if collection.image != blank %}
                                        <img
                                          src="{{ collection.image | image_url }}"
                                          alt="{{ collection.title }}"
                                          width=""
                                          height=""
                                        >
                                      {% else %}
                                        {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                                      {% endif %}
                                    </div>
                                    <div class="item_title-wrap">
                                      {% if collection.title != blank %}
                                        <h4 class="item_title">{{ collection.title }}</h4>
                                        {% render 'icon-arrow-right-svg' %}
                                      {% else %}
                                        <h4 class="item_title">Collection Title</h4>
                                        {% render 'icon-arrow-right-svg' %}
                                      {% endif %}
                                    </div>
                                    {% if collection.products_count != 0 %}
                                      <span>{{ collection.products_count }} Listings</span>
                                    {% else %}
                                      <span> - Listings</span>
                                    {% endif %}
                                  </a>
                                </div>
                              {% endfor %}
                            </div>
                          </div>
                        {% else %}
                          <div class="mega_menu-collection">
                            <div class="menu_collection-wrapper">
                              <div class="collection__items">
                                <a href="#">
                                  <div class="custom_menu_wrap">
                                    {{ 'collection-1' | placeholder_svg_tag  : 'placeholder-svg' }}
                                  </div>
                                  <div class="item_title-wrap">
                                    <h4 class="item_title">Collection Title</h4>
                                    {% render 'icon-arrow-right-svg' %}
                                  </div>
                                  <span>X Listings</span>
                                </a>
                              </div>
                              <div class="collection__items">
                                <a href="#">
                                  <div class="custom_menu_wrap">
                                    {{ 'collection-1' | placeholder_svg_tag  : 'placeholder-svg' }}
                                  </div>
                                  <div class="item_title-wrap">
                                    <h4 class="item_title">Collection Title</h4>
                                    {% render 'icon-arrow-right-svg' %}
                                  </div>
                                  <span>X Listings</span>
                                </a>
                              </div>
                              <div class="collection__items">
                                <a href="#">
                                  <div class="custom_menu_wrap">
                                    {{ 'collection-1' | placeholder_svg_tag  : 'placeholder-svg' }}
                                  </div>
                                  <div class="item_title-wrap">
                                    <h4 class="item_title">Collection Title</h4>
                                    {% render 'icon-arrow-right-svg' %}
                                  </div>
                                  <span>X Listings</span>
                                </a>
                              </div>
                            </div>
                          </div>
                        {% endif %}
                        {% comment %}{% if section.settings.product_list != blank %}{% endcomment %}
                          <div class="mega_menu-products">
                            {% assign product = section.settings.product_list %}
                            <div class="nav_featured-prod">
                              <div class="nav-product-item">
                                <a href="{{ product.url }}" class="product_menu">
                                  <div class="mega_product-img">
                                    {% if product.featured_image != blank %}
                                      <img
                                        src="{{ product.featured_image | img_url :'original' }}"
                                        alt=""
                                        width=""
                                        height=""
                                      >
                                    {% else %}
                                      {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                                    {% endif %}
                                  </div>
                                  <div class="item_title-wrap">
                                    {% if product.title != blank %}
                                      <h4 class="item_title">{{ product.title }}</h4>
                                    {% else %}
                                      <h4 class="item_title">Product Title</h4>
                                    {% endif %}
                                    {% render 'icon-arrow-right-svg' %}
                                  </div>
                                  <span>{{ product.description | truncatewords: 10 }}</span>
                                </a>
                              </div>
                            </div>
                          </div>
                        {% comment %}{% endif %}{% endcomment %}
                      </div>
                    </div>
                  </div>
                {% else %}
                  <ul
                    class="mega-menu__list page-width{% if link.levels == 1 %} mega-menu__list--condensed{% endif %}"
                    role="list"
                  >
                    {%- for childlink in link.links -%}
                      <li>
                        <a
                          id="HeaderMenu-{{ link.handle }}-{{ childlink.handle }}"
                          href="{{ childlink.url }}"
                          class="mega-menu__link mega-menu__link--level-2 link{% if childlink.current %} mega-menu__link--active{% endif %}"
                          {% if childlink.current %}
                            aria-current="page"
                          {% endif %}
                        >
                          {{ childlink.title | escape }}
                        </a>
                        {%- if childlink.links != blank -%}
                          <ul class="list-unstyled" role="list">
                            {%- for grandchildlink in childlink.links -%}
                              <li>
                                <a
                                  id="HeaderMenu-{{ link.handle }}-{{ childlink.handle }}-{{ grandchildlink.handle }}"
                                  href="{{ grandchildlink.url }}"
                                  class="mega-menu__link link{% if grandchildlink.current %} mega-menu__link--active{% endif %}"
                                  {% if grandchildlink.current %}
                                    aria-current="page"
                                  {% endif %}
                                >
                                  {{ grandchildlink.title | escape }}
                                </a>
                              </li>
                            {%- endfor -%}
                          </ul>
                        {%- endif -%}
                      </li>
                    {%- endfor -%}
                  </ul>
                {% endif %}
              </div>
            </details>
          </header-menu>
        {%- else -%}
          <a
            id="HeaderMenu-{{ link.handle }}"
            href="{{ link.url }}"
            class="header__menu-item list-menu__item link link--text focus-inset"
            {% if link.current %}
              aria-current="page"
            {% endif %}
          >
            <span
              {%- if link.current %}
                class="header__active-menu-item"
              {% endif %}
            >
              {{- link.title | escape -}}
            </span>
          </a>
        {%- endif -%}
      </li>
    {%- endfor -%}
  </ul>
</nav>

<script>
  const megaMenu = document.querySelector(".mega-menu");
  const megaMenuContent = megaMenu.querySelector(".mega-menu__content");
  let timeoutId;

  megaMenu.addEventListener("mouseenter", function () {
    megaMenu.setAttribute("open", "");
    megaMenu.classList.add("mega_menu-open");

    clearTimeout(timeoutId);
  });

  megaMenuContent.addEventListener("mouseover", function () {
    clearTimeout(timeoutId);
  });

  megaMenuContent.addEventListener("mouseout", function () {
    timeoutId = setTimeout(() => {
      megaMenu.removeAttribute("open");
      megaMenu.classList.remove("mega_menu-open");
    }, 600);
  });

  megaMenu.addEventListener("mouseleave", function (event) {
    const isMouseOutsideMegaMenu = !megaMenu.contains(event.relatedTarget);

    if (isMouseOutsideMegaMenu) {
      timeoutId = setTimeout(() => {
        megaMenu.removeAttribute("open");
        megaMenu.classList.remove("mega_menu-open");
      }, 600);
    }
  });
</script>
